name: Release Container Image

# Run when the "Release" workflow finishes
on:
  workflow_run:
    workflows:
      - Release
    types:
      - completed
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  BINARY_NAME: tele-s3

jobs:
  build-arch-images:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    strategy:
      matrix:
        include:
          - arch: amd64
            target: x86_64-unknown-linux-gnu
            platform: linux/amd64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            platform: linux/arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest release tag
        id: get_tag
        run: |
          TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.get_tag.outputs.tag }}
          TARGET: ${{ matrix.target }}
        run: |
          echo "Attempting to download artifact for $TARGET (tag: $TAG)..."
          if gh release download "$TAG" --pattern "*$TARGET.tar.xz" --dir download; then
            echo "Download successful!"
          fi

      - name: Extract Binary
        run: |
          cd download
          # Extract the tarball
          tar -xvf *${{ matrix.target }}.tar.xz
          
          # Locate the binary inside the extracted folder and move to root
          FOUND_BIN=$(find . -name "${{ env.BINARY_NAME }}" -type f | head -n 1)
          
          if [ -z "$FOUND_BIN" ]; then
            echo "Could not find binary named ${{ env.BINARY_NAME }} in extracted files"
            exit 1
          fi
          
          mv "$FOUND_BIN" ../${{ env.BINARY_NAME }}
          chmod +x ../${{ env.BINARY_NAME }}
          
          echo "Binary moved to project root successfully."

      - name: Build and push intermediate image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .github/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_tag.outputs.tag }}-${{ matrix.arch }}
          build-args: |
            BINARY_NAME=${{ env.BINARY_NAME }}

  create-manifest:
    needs: build-arch-images
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and Push Manifest
        run: |
          BASE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          TAG="${{ needs.build-arch-images.outputs.tag }}"
          
          # 1. Create the specific version tag (e.g. v1.0.0)
          # combining amd64 and arm64
          docker buildx imagetools create -t ${BASE}:${TAG} \
            ${BASE}:${TAG}-amd64 \
            ${BASE}:${TAG}-arm64
            
          # 2. Update the 'latest' tag
          docker buildx imagetools create -t ${BASE}:latest \
            ${BASE}:${TAG}-amd64 \
            ${BASE}:${TAG}-arm64
            
          echo "Successfully pushed ${BASE}:${TAG} and ${BASE}:latest"
